<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Web Application Pentesting - Cyber Buddy Academy</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0a0e17; --surface:#141a2a; --primary:#00ffe0; --text:#e0e0e0; --muted:#888; --danger:#ff4d4d; }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
    header { padding:1rem 2rem; background:rgba(10,14,23,.95); border-bottom:1px solid rgba(0,255,224,.1); display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:100; }
    .logo { height:48px; }
    nav a, nav button { color:var(--text); margin:0 12px; text-decoration:none; background:none; border:none; cursor:pointer; font-weight:500; }
    nav a:hover, nav button:hover { color:var(--primary); }
    .user-info { display:flex; align-items:center; gap:12px; }
    .profile-pic { width:42px; height:42px; border-radius:50%; border:2px solid var(--primary); object-fit:cover; }

    .loader { position:fixed; inset:0; background:var(--bg); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:1rem; }
    .spinner { width:50px; height:50px; border:5px solid #222; border-top-color:var(--primary); border-radius:50%; animation:s 1s linear infinite; }
    @keyframes s { to { transform:rotate(360deg); } }

    .container { max-width:1100px; margin:2rem auto; padding:0 1rem; opacity:0; transition:opacity .6s; }
    .container.ready { opacity:1; }
    h1 { font-size:2rem; color:var(--primary); text-align:center; margin-bottom:1.5rem; }

    .course-card { background:var(--surface); border-radius:16px; padding:1.5rem; border:1px solid rgba(0,255,224,.1); }
    .meta { display:flex; gap:1.5rem; margin-bottom:1rem; flex-wrap:wrap; }
    .meta img { width:100%; max-width:300px; height:170px; object-fit:cover; border-radius:12px; }
    .video-wrapper { position:relative; border-radius:12px; overflow:hidden; background:#000; margin:1.5rem 0; box-shadow:0 10px 30px rgba(0,0,0,.5); }
    video { width:100%; display:block; max-height:70vh; }
    .video-overlay { position:absolute; inset:0; background:rgba(0,0,0,.9); display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; opacity:0; transition:opacity .3s; }
    .video-wrapper.error .video-overlay { opacity:1; }

    .controls { display:flex; flex-wrap:wrap; gap:1rem; justify-content:center; align-items:center; margin:1rem 0; }
    select, input[type=range], button { background:var(--primary); color:#000; border:none; padding:.5rem .9rem; border-radius:8px; font-weight:600; cursor:pointer; }
    .progress-bar { height:8px; background:#222; border-radius:8px; overflow:hidden; margin:1rem 0; }
    .progress-fill { height:100%; background:var(--primary); width:0%; transition:width .3s; }

    details { margin-top:1rem; }
    summary { cursor:pointer; color:var(--primary); font-weight:600; }
    .list { list-style:none; margin-top:.5rem; display:flex; flex-direction:column; gap:.4rem; }
    .list li { display:flex; justify-content:space-between; padding:.6rem 1rem; background:rgba(255,255,255,.03); border-radius:8px; }

    .access-denied { text-align:center; padding:2rem; background:rgba(255,77,77,.1); border:1px solid var(--danger); border-radius:12px; color:var(--danger); }

    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.9); z-index:2000; display:none; align-items:center; justify-content:center; }
    .modal { background:var(--surface); padding:2rem; border-radius:16px; text-align:center; max-width:400px; width:90%; border:1px solid rgba(0,255,224,.2); }

    footer { text-align:center; padding:2rem; color:var(--muted); margin-top:4rem; }
  </style>
</head>
<body>

  <!-- Loader -->
  <div class="loader" id="loader">
    <div class="spinner"></div>
    <div id="loaderText">Initializing Cyber Buddy Academy...</div>
  </div>

  <!-- Header -->
  <header style="display:none" id="header">
    <div style="display:flex; align-items:center; gap:15px;">
      <img src="https://raw.githubusercontent.com/Mubyyy404/photo-2/refs/heads/main/mylogo.png" class="logo" alt="Logo">
      <strong style="color:var(--primary)">Cyber Buddy Academy</strong>
    </div>
    <div style="display:flex; align-items:center; gap:20px;">
      <nav>
        <a href="dashboard.html">Courses</a>
        <a href="course.html">My Courses</a>
        <a href="profile.html">Profile</a>
      </nav>
      <div class="user-info">
        <img id="profilePic" class="profile-pic" src="images/default-avatar.png" alt="Profile">
        <span id="userName" style="color:var(--primary); font-weight:600">Student</span>
      </div>
      <button id="logoutBtn">Logout</button>
    </div>
  </header>

  <div class="container" id="container">
    <h1>Web Application Penetration Testing</h1>

    <div id="accessDenied" class="access-denied" style="display:none">
      <strong>Access Denied</strong><br><br>
      You haven't purchased this course.<br><br>
      <a href="dashboard.html" style="color:var(--primary);">← Back to Dashboard</a>
    </div>

    <section id="courseContent" class="course-card" style="display:none">
      <div class="meta">
        <img src="https://raw.githubusercontent.com/Mubyyy404/photo-2/refs/heads/main/Cloud%20Security.png" alt="Course">
        <div>
          <h2 style="color:var(--primary)">Web Application Pentesting</h2>
          <p style="color:var(--muted)">Master SQL Injection, XSS, CSRF, IDOR, authentication bypass, and more with hands-on labs.</p>
        </div>
      </div>

      <div class="video-wrapper" id="videoWrapper">
        <video id="courseVideo" controls preload="metadata" playsinline></video>
        <div class="video-overlay">
          <div>Video failed to load</div>
          <button id="retryVideo" style="margin-top:1rem;">Retry</button>
        </div>
      </div>

      <div class="controls">
        <div style="display:flex; align-items:center; gap:10px;">
          <label>Speed:</label>
          <select id="playbackSpeed">
            <option value="0.5">0.5x</option>
            <option value="0.75">0.75x</option>
            <option value="1" selected>1x</option>
            <option value="1.25">1.25x</option>
            <option value="1.5">1.5x</option>
            <option value="2">2x</option>
          </select>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
          <label>Vol:</label>
          <input id="volumeControl" type="range" min="0" max="1" step="0.05" value="1">
        </div>
        <button id="fullscreenBtn">Fullscreen</button>
        <button id="saveBookmark">Bookmark</button>
        <button id="resetProgress" style="background:var(--danger)">Reset Progress</button>
      </div>

      <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
      <p style="text-align:center; margin:8px 0;">Watched: <span id="progressText">0%</span></p>

      <details><summary>Bookmarks (<span id="bmCount">0</span>)</summary>
        <ul id="bookmarksList" class="list"><li style="color:#666">No bookmarks yet</li></ul>
      </details>

      <details open><summary>Chapters</summary>
        <ul id="chaptersList" class="list"></ul>
      </details>
    </section>
  </div>

  <footer style="display:none">© 2025 Cyber Buddy Academy — All Rights Reserved</footer>

  <!-- Resume Modal -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <h3>Resume where you left off?</h3>
      <p id="resumeText">Continue from 45:32 (68.4%)?</p>
      <div style="margin-top:1rem; display:flex; gap:1rem; justify-content:center;">
        <button id="resumeYes">Yes, Continue</button>
        <button id="resumeNo">Start Over</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB2Zf5v8pK7z9xYcXvWqRtLkMhNjPxQmA0",
      authDomain: "cyber-buddy-academy.firebaseapp.com",
      projectId: "cyber-buddy-academy",
      storageBucket: "cyber-buddy-academy.appspot.com",
      messagingSenderId: "771234567890",
      appId: "1:771234567890:web:abcdef1234567890abcdef"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const els = {
      loader: document.getElementById('loader'),
      loaderText: document.getElementById('loaderText'),
      header: document.getElementById('header'),
      container: document.getElementById('container'),
      footer: document.getElementById('footer'),
      accessDenied: document.getElementById('accessDenied'),
      courseContent: document.getElementById('courseContent'),
      video: document.getElementById('courseVideo'),
      videoWrapper: document.getElementById('videoWrapper'),
      retryVideo: document.getElementById('retryVideo'),
      progressFill: document.getElementById('progressFill'),
      progressText: document.getElementById('progressText'),
      playbackSpeed: document.getElementById('playbackSpeed'),
      volumeControl: document.getElementById('volumeControl'),
      fullscreenBtn: document.getElementById('fullscreenBtn'),
      saveBookmark: document.getElementById('saveBookmark'),
      resetProgress: document.getElementById('resetProgress'),
      bookmarksList: document.getElementById('bookmarksList'),
      bmCount: document.getElementById('bmCount'),
      chaptersList: document.getElementById('chaptersList'),
      profilePic: document.getElementById('profilePic'),
      userName: document.getElementById('userName'),
      logoutBtn: document.getElementById('logoutBtn'),
      modalBackdrop: document.getElementById('modalBackdrop'),
      resumeText: document.getElementById('resumeText'),
      resumeYes: document.getElementById('resumeYes'),
      resumeNo: document.getElementById('resumeNo')
    };

    // CHANGE THIS TO YOUR REAL VIDEO URL
    const VIDEO_URL = "https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4"; // Test video (works instantly)

    const COURSE_ID = "web-pentesting";
    const PROGRESS_FIELD = "webPentestingProgress";
    const BOOKMARK_FIELD = "webPentestingBookmarks";

    let userRef = null;
    let bookmarks = [];
    let pendingResumePct = 0;
    let authChecked = false;

    const CHAPTERS = [
      { time: 0, label: "Introduction" },
      { time: 60, label: "SQL Injection" },
      { time: 120, label: "XSS Attacks" },
      { time: 180, label: "CSRF & IDOR" }
    ];

    function formatTime(s) { const m = Math.floor(s/60); const sec = Math.floor(s%60); return `${m}:${sec.toString().padStart(2,'0')}`; }

    function showUI() {
      els.loader.style.display = 'none';
      els.header.style.display = 'flex';
      els.footer.style.display = 'block';
      els.container.classList.add('ready');
    }

    async function startCourse(user) {
      els.loaderText.textContent = "Loading your progress...";
      els.userName.textContent = user.displayName || user.email.split('@')[0];
      els.profilePic.src = user.photoURL || "images/default-avatar.png";

      userRef = doc(db, "users", user.uid);
      const snap = await getDoc(userRef);
      const data = snap.exists() ? snap.data() : {};

      const hasAccess = (data.purchasedCourses || []).includes(COURSE_ID);
      if (!hasAccess) {
        els.accessDenied.style.display = "block";
        showUI();
        setTimeout(() => location.href = "dashboard.html", 4000);
        return;
      }

      pendingResumePct = data[PROGRESS_FIELD] || 0;
      bookmarks = Array.isArray(data[BOOKMARK_FIELD]) ? data[BOOKMARK_FIELD] : [];

      els.courseContent.style.display = "block";
      els.video.src = VIDEO_URL;

      els.video.onloadedmetadata = () => {
        els.loaderText.textContent = "Ready!";
        showUI();

        if (pendingResumePct > 5 && pendingResumePct < 95) {
          els.resumeText.textContent = `Continue from ${formatTime((pendingResumePct/100)*els.video.duration)} (${pendingResumePct.toFixed(1)}%)?`;
          els.modalBackdrop.style.display = "flex";
        }
      };

      els.video.onerror = () => els.videoWrapper.classList.add("error");
      els.retryVideo.onclick = () => location.reload();

      // Controls
      els.playbackSpeed.onchange = () => els.video.playbackRate = parseFloat(els.playbackSpeed.value);
      els.volumeControl.oninput = () => els.video.volume = els.volumeControl.value;
      els.fullscreenBtn.onclick = () => els.video.requestFullscreen();

      let saveTimer;
      els.video.ontimeupdate = () => {
        const pct = (els.video.currentTime / els.video.duration) * 100 || 0;
        els.progressFill.style.width = pct + "%";
        els.progressText.textContent = pct.toFixed(1) + "%";
        clearTimeout(saveTimer);
        saveTimer = setTimeout(() => updateDoc(userRef, { [PROGRESS_FIELD]: Math.round(pct) }), 15000);
      };

      els.video.onended = () => updateDoc(userRef, { [PROGRESS_FIELD]: 100 });

      els.saveBookmark.onclick = () => {
        const t = Math.floor(els.video.currentTime);
        if (!bookmarks.includes(t)) {
          bookmarks.push(t);
          updateDoc(userRef, { [BOOKMARK_FIELD]: bookmarks });
          renderBookmarks();
        }
      };

      els.resetProgress.onclick = () => {
        if (confirm("Reset all progress?")) {
          els.video.currentTime = 0;
          bookmarks = [];
          updateDoc(userRef, { [PROGRESS_FIELD]: 0, [BOOKMARK_FIELD]: [] });
          els.progressFill.style.width = "0%";
          els.progressText.textContent = "0%";
          renderBookmarks();
        }
      };

      els.resumeYes.onclick = () => {
        els.video.currentTime = (pendingResumePct/100) * els.video.duration;
        els.video.play();
        els.modalBackdrop.style.display = "none";
      };
      els.resumeNo.onclick = () => { els.video.currentTime = 0; els.modalBackdrop.style.display = "none"; };

      function renderBookmarks() {
        els.bmCount.textContent = bookmarks.length;
        els.bookmarksList.innerHTML = bookmarks.length ? "" : '<li style="color:#666">No bookmarks yet</li>';
        bookmarks.sort((a,b)=>a-b).forEach(t => {
          const li = document.createElement("li");
          li.innerHTML = `<span>Time: ${formatTime(t)}</span><button>Go</button>`;
          li.querySelector("button").onclick = () => { els.video.currentTime = t; els.video.play(); };
          els.bookmarksList.appendChild(li);
        });
      }

      CHAPTERS.forEach(ch => {
        const li = document.createElement("li");
        li.innerHTML = `<span>${ch.label}</span><button>Watch</button>`;
        li.querySelector("button").onclick = () => { els.video.currentTime = ch.time; els.video.play(); };
        els.chaptersList.appendChild(li);
      });

      renderBookmarks();
    }

    // THE FIXED AUTH CHECK — NO MORE FALSE REDIRECTS
    onAuthStateChanged(auth, (user) => {
      if (authChecked) return;
      authChecked = true;

      if (!user) {
        els.loaderText.textContent = "Not logged in → redirecting...";
        setTimeout(() => location.href = "login.html", 2000);
        return;
      }

      startCourse(user);
    });

    // Safety net (12-second max wait)
    setTimeout(() => {
      if (!authChecked && !auth.currentUser) {
        els.loaderText.textContent = "Taking too long → login again";
        setTimeout(() => location.href = "login.html", 2000);
      }
    }, 12000);

    els.logoutBtn.onclick = () => signOut(auth).then(() => location.href = "login.html");
  </script>
</body>
</html>
