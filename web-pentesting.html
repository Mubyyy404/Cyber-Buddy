<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Web Application Penetration Testing ‚Äì Cyber Buddy Academy</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    :root{--bg:#0a0e17;--surface:#141a2a;--primary:#00ffe0;--text:#e0e0e0;--muted:#9ca3af;--danger:#ff4d4d}
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;line-height:1.5}
    header{display:flex;align-items:center;justify-content:space-between;padding:.8rem 1.2rem;background:rgba(10,14,23,.95);border-bottom:1px solid rgba(0,255,224,.06);position:sticky;top:0;z-index:100}
    .logo{height:44px}
    .user-info{display:flex;align-items:center;gap:.7rem}
    .profile-pic{width:38px;height:38px;border-radius:50%;object-fit:cover;border:2px solid var(--primary)}
    nav{display:flex;gap:1rem;align-items:center}
    nav a,nav button{color:var(--text);background:none;border:none;cursor:pointer;text-decoration:none;font-weight:600}
    nav a:hover,nav button:hover{color:var(--primary)}
    .container{max-width:1100px;margin:2rem auto;padding:0 1rem;opacity:0;transition:opacity .45s}
    .container.ready{opacity:1}
    h1{font-size:1.9rem;color:var(--primary);text-align:center;margin-bottom:1rem}
    .course-card{background:var(--surface);border-radius:12px;padding:1.25rem;box-shadow:0 8px 30px rgba(0,255,224,.03)}
    .meta{display:flex;gap:1rem;align-items:center;margin-bottom:.8rem}
    .meta img{width:90px;height:60px;object-fit:cover;border-radius:8px}
    .video-wrapper{position:relative;border-radius:10px;overflow:hidden;background:#000;margin-bottom:1rem;min-height:140px;display:flex;align-items:center;justify-content:center}
    video{width:100%;display:block;max-height:60vh}
    .video-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);color:#fff;font-weight:600;opacity:0;transition:opacity .18s}
    .video-wrapper.error .video-overlay{opacity:1}
    .controls{display:flex;flex-wrap:wrap;gap:.6rem;align-items:center;justify-content:center;margin:.8rem 0}
    select,input[type=range],button{background:var(--primary);color:#000;border:none;border-radius:6px;padding:.35rem .6rem;font-weight:700;cursor:pointer}
    .control-group{display:flex;align-items:center;gap:.5rem}
    .progress-bar{height:8px;background:#222;border-radius:6px;overflow:hidden;margin:.8rem 0}
    .progress-fill{height:100%;background:var(--primary);width:0;transition:width .25s}
    details summary{cursor:pointer;font-weight:700;color:var(--primary)}
    .list{list-style:none;margin-top:.5rem;display:flex;flex-direction:column;gap:.4rem}
    .list li{display:flex;justify-content:space-between;align-items:center;padding:.45rem .7rem;background:rgba(255,255,255,.02);border-radius:6px}
    .access-denied{padding:1rem;border-radius:8px;background:rgba(255,77,77,.06);border:1px solid rgba(255,77,77,.12);color:var(--danger);text-align:center}
    .loader{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;background:var(--bg);z-index:9999}
    .spinner{width:46px;height:46px;border:5px solid #222;border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    footer{text-align:center;padding:16px;color:var(--muted);font-size:13px;margin-top:2rem}
    @media(max-width:768px){header{flex-direction:column;align-items:flex-start;gap:.5rem}.meta{flex-direction:column;align-items:flex-start}.meta img{width:100%;height:120px}}
    .notice{padding:.6rem;border-radius:8px;background:rgba(255,255,255,.03);color:var(--muted);margin-top:.6rem}
    .error-text{color:var(--danger);font-weight:700}
  </style>
</head>
<body>
  <!-- Loader -->
  <div class="loader" id="loader" role="status">
    <div class="spinner" aria-hidden="true"></div>
    <div id="loaderText">Initializing Cyber Buddy Academy‚Ä¶</div>
  </div>

  <!-- Header -->
  <header id="header" style="display:none">
    <div style="display:flex;align-items:center;gap:.9rem">
      <img class="logo" src="https://raw.githubusercontent.com/Mubyyy404/photo-2/main/mylogo.png" alt="logo">
      <strong style="color:var(--primary)">Cyber Buddy Academy</strong>
    </div>

    <div style="display:flex;align-items:center;gap:1rem">
      <nav>
        <a href="dashboard.html">Dashboard</a>
        <a href="course.html">My Courses</a>
        <a href="profile.html">Profile</a>
      </nav>

      <div class="user-info" aria-live="polite">
        <img id="profilePic" class="profile-pic" src="images/default-avatar.png" alt="profile">
        <div id="userName" style="color:var(--primary);font-weight:700">Loading...</div>
      </div>

      <button id="logoutBtn" style="margin-left:10px;background:none;color:var(--text);border:1px solid rgba(255,255,255,0.04);padding:.4rem .6rem;border-radius:8px;cursor:pointer">Logout</button>
      <button id="themeToggle" title="Toggle theme" style="background:none;border:none;color:var(--primary);margin-left:.5rem"><i data-lucide="moon"></i></button>
    </div>
  </header>

  <main class="container" id="container" aria-live="polite">
    <h1 id="courseTitle">Web Application Penetration Testing</h1>

    <div id="accessDenied" class="access-denied" style="display:none">
      <div><strong>Access Denied:</strong> You have not purchased this course.</div>
      <div style="margin-top:.6rem;color:var(--muted)">You will be redirected to dashboard shortly.</div>
    </div>

    <section id="courseContent" class="course-card" style="display:none" aria-hidden="true">
      <div class="meta">
        <img id="courseImage" src="https://raw.githubusercontent.com/Mubyyy404/photo-2/refs/heads/main/Cloud%20Security.png" alt="course image">
        <div>
          <h2 id="courseLabel" style="margin:0;color:var(--primary)">Web Application Pentesting</h2>
          <p id="courseDesc" style="margin:.5rem 0 .2rem;color:var(--muted);max-width:60ch">Learn to identify, exploit, and secure web applications through hands-on labs.</p>
          <div id="videoStatus" class="notice" style="display:none"></div>
        </div>
      </div>

      <div class="video-wrapper" id="videoWrapper">
        <video id="courseVideo" preload="metadata" controls playsinline>
          <!-- Source will be attached dynamically after verification -->
        </video>

        <div class="video-overlay" id="videoError">
          <div>
            <div id="videoErrorText">Video failed to load or is blocked.</div>
            <div style="margin-top:.6rem"><button id="retryVideo" style="padding:.45rem .7rem;border-radius:8px">Retry</button></div>
          </div>
        </div>
      </div>

      <div class="controls" role="region" aria-label="video controls">
        <div class="control-group"><label for="playbackSpeed" style="font-weight:700">Speed:</label>
          <select id="playbackSpeed"><option value="0.5">0.5x</option><option value="0.75">0.75x</option><option value="1" selected>1x</option><option value="1.25">1.25x</option><option value="1.5">1.5x</option><option value="2">2x</option></select>
        </div>

        <div class="control-group"><label style="font-weight:700">Vol:</label><input id="volumeControl" type="range" min="0" max="1" step="0.05" value="1"></div>

        <button id="fullscreenBtn">Fullscreen</button>
        <button id="saveBookmark">Bookmark</button>
        <button id="resetProgress" style="background:var(--danger)">Reset</button>
      </div>

      <div class="progress-bar"><div id="progressFill" class="progress-fill" style="width:0%"></div></div>
      <p id="progressText" style="text-align:center;margin-top:6px">Watched: 0%</p>

      <details style="margin-top:1rem"><summary>Bookmarks (<span id="bmCount">0</span>)</summary><ul id="bookmarksList" class="list"></ul></details>
      <details style="margin-top:.8rem"><summary>Chapters</summary><ul id="chaptersList" class="list"></ul></details>

      <h3 style="margin-top:1rem;color:var(--primary)">Key Topics</h3>
      <ul style="margin:.6rem 0 0 1.1rem;color:var(--muted)"><li>Introduction to Web Security</li><li>SQL Injection, XSS</li><li>Exploitation Techniques</li><li>Secure Coding</li><li>Pen Testing Tools</li></ul>
    </section>
  </main>

  <footer id="footer" style="display:none">¬© 2025 Cyber Buddy Academy ‚Äî All Rights Reserved</footer>

  <script type="module">
    // ======================= CONFIG =======================
    // Primary video URL (change this if you host the file elsewhere)
    const VIDEO_URL = 'https://firebasestorage.googleapis.com/v0/b/cyber-buddy-academy.appspot.com/o/courses%2Fweb-pentesting-video.mp4?alt=media';
    // ======================================================

    // Firebase v9 modular
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB2Zf5v8pK7z9xYcXvWqRtLkMhNjPxQmA0",
      authDomain: "cyber-buddy-academy.firebaseapp.com",
      projectId: "cyber-buddy-academy",
      storageBucket: "cyber-buddy-academy.appspot.com",
      messagingSenderId: "771234567890",
      appId: "1:771234567890:web:abcdef1234567890abcdef"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // elements
    const els = {
      loader: document.getElementById('loader'),
      loaderText: document.getElementById('loaderText'),
      header: document.getElementById('header'),
      container: document.getElementById('container'),
      footer: document.getElementById('footer'),
      courseTitle: document.getElementById('courseTitle'),
      courseImage: document.getElementById('courseImage'),
      courseDesc: document.getElementById('courseDesc'),
      courseLabel: document.getElementById('courseLabel'),
      accessDenied: document.getElementById('accessDenied'),
      courseContent: document.getElementById('courseContent'),
      profilePic: document.getElementById('profilePic'),
      userName: document.getElementById('userName'),
      logoutBtn: document.getElementById('logoutBtn'),
      video: document.getElementById('courseVideo'),
      videoWrapper: document.getElementById('videoWrapper'),
      videoError: document.getElementById('videoError'),
      retryVideo: document.getElementById('retryVideo'),
      progressFill: document.getElementById('progressFill'),
      progressText: document.getElementById('progressText'),
      playbackSpeed: document.getElementById('playbackSpeed'),
      volumeControl: document.getElementById('volumeControl'),
      fullscreenBtn: document.getElementById('fullscreenBtn'),
      saveBookmark: document.getElementById('saveBookmark'),
      resetProgress: document.getElementById('resetProgress'),
      bookmarksList: document.getElementById('bookmarksList'),
      bmCount: document.getElementById('bmCount'),
      chaptersList: document.getElementById('chaptersList'),
      themeToggle: document.getElementById('themeToggle'),
      videoStatus: document.getElementById('videoStatus'),
      videoErrorText: document.getElementById('videoErrorText')
    };

    const COURSE_DOC_ID = 'web-pentesting';
    const COURSE_ID = 'web-pentesting';
    const PROGRESS_FIELD = 'webPentestingProgress';
    const BOOKMARK_FIELD = 'webPentestingBookmarks';
    const COMPLETED_FIELD = 'webPentestingCompleted';

    let userRef = null;
    let userData = null;
    let bookmarks = [];
    let saveTimer = null;
    let authResolved = false;

    const CHAPTERS = [
      { time: 0, label: 'Introduction' },
      { time: 300, label: 'SQL Injection' },
      { time: 600, label: 'XSS Attacks' },
      { time: 900, label: 'Exploitation Techniques' }
    ];

    // ===== helpers =====
    function showLoaderText(t){ els.loaderText.textContent = t; }
    function showUI(){ els.loader.style.display='none'; els.header.style.display='flex'; els.container.classList.add('ready'); els.footer.style.display='block'; }
    function hideCourse(){ els.courseContent.style.display='none'; els.accessDenied.style.display='none'; }
    function formatTime(sec){ const m=Math.floor(sec/60), s=Math.floor(sec%60); return `${m}:${s.toString().padStart(2,'0')}`; }

    function userHasCourse(userDoc, courseId){
      if(!userDoc) return false;
      const arrCandidates = [];
      if(Array.isArray(userDoc.purchasedCourses)) arrCandidates.push(userDoc.purchasedCourses);
      if(Array.isArray(userDoc.courses)) arrCandidates.push(userDoc.courses);
      if(Array.isArray(userDoc.coursesPurchased)) arrCandidates.push(userDoc.coursesPurchased);
      for(const arr of arrCandidates){
        for(const v of arr){
          if(typeof v === 'string' && v.toLowerCase() === courseId.toLowerCase()) return true;
          if(v && typeof v === 'object' && (v.id === courseId || (v.id && v.id.toLowerCase()===courseId.toLowerCase()))) return true;
        }
      }
      if(userDoc.purchasedCourses && typeof userDoc.purchasedCourses === 'object' && !Array.isArray(userDoc.purchasedCourses)){
        if(userDoc.purchasedCourses[courseId]) return true;
      }
      if(userDoc.courses && typeof userDoc.courses === 'object' && !Array.isArray(userDoc.courses)){
        if(userDoc.courses[courseId]) return true;
      }
      return false;
    }

    // try a HEAD request to the video url to verify availability
    async function verifyVideoUrl(url, timeoutMs = 6000){
      try{
        // Use fetch with method HEAD where supported
        const controller = new AbortController();
        const id = setTimeout(()=> controller.abort(), timeoutMs);
        const res = await fetch(url, { method: 'HEAD', signal: controller.signal, cache: 'no-store' });
        clearTimeout(id);
        // Accept 200 OK; also allow 206 (partial content) for range-friendly endpoints
        if(res.status === 200 || res.status === 206) return { ok:true };
        return { ok:false, status: res.status, statusText: res.statusText };
      }catch(err){
        // Some hosts block HEAD; try a GET that asks for 1 byte (range)
        try{
          const controller = new AbortController();
          const id = setTimeout(()=> controller.abort(), timeoutMs);
          const res = await fetch(url, { method: 'GET', headers: { Range: 'bytes=0-1' }, signal: controller.signal, cache:'no-store' });
          clearTimeout(id);
          if(res.status === 200 || res.status === 206) return { ok:true };
          return { ok:false, status: res.status, statusText: res.statusText };
        }catch(e){
          return { ok:false, error: e.message || String(e) };
        }
      }
    }

    async function loadCourseMeta(){
      try{
        const cdoc = doc(db, 'courses', COURSE_DOC_ID);
        const snap = await getDoc(cdoc);
        if(snap.exists()){
          const d = snap.data();
          if(d.title) els.courseLabel.textContent = d.title;
          if(d.description) els.courseDesc.textContent = d.description;
          if(d.image) els.courseImage.src = d.image;
          if(d.value) els.courseTitle.textContent = d.value;
        }
      }catch(e){ console.warn('Failed to load course meta', e); }
    }

    async function saveProgress(pct){
      if(!userRef) return;
      try{ await updateDoc(userRef, { [PROGRESS_FIELD]: Math.max(0, Math.min(100, Math.floor(pct))) }); }
      catch(e){ console.warn('Could not save progress', e); }
    }
    async function saveBookmarks(arr){
      if(!userRef) return;
      try{ await updateDoc(userRef, { [BOOKMARK_FIELD]: arr }); }
      catch(e){ console.warn('Could not save bookmarks', e); }
    }

    async function renderBookmarks(){
      try{
        if(userRef){
          const snap = await getDoc(userRef);
          if(snap.exists()){
            const db = snap.data();
            bookmarks = Array.isArray(db[BOOKMARK_FIELD]) ? db[BOOKMARK_FIELD].slice() : bookmarks;
          }
        }
      }catch(e){ console.warn('refresh bookmarks failed', e); }
      els.bmCount.textContent = bookmarks.length;
      els.bookmarksList.innerHTML = '';
      if(!bookmarks.length){ els.bookmarksList.innerHTML = '<li style="color:#999">No bookmarks yet</li>'; return; }
      bookmarks.sort((a,b)=>a-b);
      bookmarks.forEach(sec=>{
        const li = document.createElement('li');
        li.innerHTML = `<span>‚è± ${formatTime(sec)}</span>`;
        const btn = document.createElement('button'); btn.textContent='Go';
        btn.onclick = ()=> { els.video.currentTime = sec; els.video.play(); };
        li.appendChild(btn);
        els.bookmarksList.appendChild(li);
      });
    }

    async function initPlayerState(){
      try{
        if(!userRef) return;
        const snap = await getDoc(userRef);
        const db = snap.exists() ? snap.data() : {};
        const pct = Number(db[PROGRESS_FIELD] ?? 0);
        bookmarks = Array.isArray(db[BOOKMARK_FIELD]) ? db[BOOKMARK_FIELD].slice() : [];
        const trySetCurrent = ()=>{
          if(!isFinite(els.video.duration) || els.video.duration <= 0) return false;
          els.video.currentTime = Math.min(els.video.duration, (pct/100)*els.video.duration);
          updateProgressUI(pct);
          return true;
        };
        els.video.addEventListener('loadedmetadata', ()=> trySetCurrent() );
        trySetCurrent();
        renderBookmarks();
      }catch(e){ console.warn('init player state failed', e); }
    }

    function updateProgressUI(pct){
      const p = Math.max(0, Math.min(100, Number(pct) || 0));
      els.progressFill.style.width = p + '%';
      els.progressText.textContent = `Watched: ${p.toFixed(1)}%`;
    }

    function setupVideoControls(){
      const v = els.video;
      v.volume = els.volumeControl.value = 1;
      v.playbackRate = Number(els.playbackSpeed.value) || 1;

      v.addEventListener('timeupdate', ()=>{
        const pct = (v.currentTime / Math.max(1, v.duration)) * 100 || 0;
        updateProgressUI(pct);
        if(saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(()=> saveProgress(Math.floor(pct)), 10000);
      });

      ['pause','ended'].forEach(ev=>{
        v.addEventListener(ev, async ()=>{
          const pct = Math.floor((v.currentTime / Math.max(1, v.duration)) * 100) || 0;
          await saveProgress(pct);
          if(ev === 'ended' && pct >= 95){
            try{ await updateDoc(userRef, { [COMPLETED_FIELD]: true }); } catch(e){ console.warn('mark complete failed', e); }
            alert('üéâ Congratulations! Course Completed!');
          }
        });
      });

      v.addEventListener('error', ()=> { els.videoWrapper.classList.add('error'); });

      els.retryVideo.onclick = ()=> location.reload();

      els.playbackSpeed.onchange = ()=> v.playbackRate = parseFloat(els.playbackSpeed.value);
      els.volumeControl.oninput = ()=> v.volume = els.volumeControl.value;
      els.fullscreenBtn.onclick = ()=> { try{ v.requestFullscreen?.(); }catch(e){ try{ v.webkitRequestFullscreen?.(); }catch{} } };

      els.saveBookmark.onclick = async ()=>{
        const t = Math.floor(v.currentTime || 0);
        if(bookmarks.includes(t)){ return alert('Already bookmarked!'); }
        bookmarks.push(t);
        bookmarks = Array.from(new Set(bookmarks)).sort((a,b)=>a-b);
        await saveBookmarks(bookmarks);
        renderBookmarks();
      };

      els.resetProgress.onclick = async ()=>{
        if(!confirm('Reset all progress?')) return;
        v.currentTime = 0;
        bookmarks = [];
        try{ await updateDoc(userRef, { [PROGRESS_FIELD]: 0, [BOOKMARK_FIELD]: [], [COMPLETED_FIELD]: false }); }catch(e){ console.warn('reset failed', e); }
        updateProgressUI(0);
        renderBookmarks();
      };

      document.addEventListener('keydown', e=>{
        if(['INPUT','TEXTAREA'].includes(e.target.tagName)) return;
        if(e.key === ' '){ e.preventDefault(); v.paused ? v.play() : v.pause(); }
        if(e.key === 'ArrowLeft') v.currentTime = Math.max(0, v.currentTime - 5);
        if(e.key === 'ArrowRight') v.currentTime = Math.min(v.duration || Infinity, v.currentTime + 5);
        if(e.key === 'f') els.fullscreenBtn.click();
      });
    }

    async function onUserReady(user){
      userRef = doc(db, 'users', user.uid);
      try{
        const snap = await getDoc(userRef);
        userData = snap.exists() ? snap.data() : {};
        loadCourseMeta();
        const allowed = userHasCourse(userData, COURSE_ID);
        showUI();
        els.userName.textContent = `Hi, ${user.displayName || userData.name || (user.email ? user.email.split('@')[0] : 'Student')}`;
        els.profilePic.src = userData.profilePic || user.photoURL || 'images/default-avatar.png';

        if(!allowed){
          els.accessDenied.style.display = 'block';
          els.courseContent.style.display = 'none';
          setTimeout(()=> location.href = 'dashboard.html', 2500);
          return;
        }

        els.accessDenied.style.display = 'none';
        els.courseContent.style.display = 'block';

        // verify video availability before attaching the source
        els.videoStatus.style.display = 'none';
        els.videoStatus.textContent = '';
        const vcheck = await verifyVideoUrl(VIDEO_URL, 6000);
        if(!vcheck.ok){
          // show friendly message but don't redirect
          const errText = (vcheck.status ? `HTTP ${vcheck.status}` : '') + (vcheck.statusText ? ` ${vcheck.statusText}` : '') + (vcheck.error ? ` ${vcheck.error}` : '');
          els.videoStatus.style.display = 'block';
          els.videoStatus.innerHTML = `<span class="error-text">Video unavailable (${errText || 'not found'}).</span><div style="margin-top:.5rem;color:var(--muted)">Please upload the course video to Firebase Storage at path <code>courses/web-pentesting-video.mp4</code> or update the VIDEO_URL in this page.</div>`;
          // still initialize player controls so user can see UI and bookmarks
          setupVideoControls();
          await initPlayerState();
          renderBookmarks();
          return;
        }

        // attach source and init player as usual
        const sourceEl = document.createElement('source');
        sourceEl.src = VIDEO_URL;
        sourceEl.type = 'video/mp4';
        els.video.appendChild(sourceEl);

        setupVideoControls();
        await initPlayerState();
        renderBookmarks();
        renderChapters();
        lucide.createIcons();
      }catch(e){ console.error('onUserReady error', e); alert('Failed to load your course data. Try refreshing the page.'); }
    }

    function renderChapters(){
      els.chaptersList.innerHTML = '';
      CHAPTERS.forEach(ch=>{
        const li = document.createElement('li');
        li.innerHTML = `<span>${ch.label}</span>`;
        const btn = document.createElement('button'); btn.textContent='Watch';
        btn.onclick = ()=> { if(els.video.src) { els.video.currentTime = ch.time; els.video.play(); } else alert('Video not available.'); };
        li.appendChild(btn);
        els.chaptersList.appendChild(li);
      });
    }

    // auth: wait for actual Firebase state; avoid immediate redirect
    onAuthStateChanged(auth, async (user) => {
      authResolved = true;
      if(!user){
        showLoaderText('Please login to continue‚Ä¶ Redirecting to login if session not found.');
        // fallback redirect after 7s only if still not signed in
        setTimeout(()=> { if(!auth.currentUser) location.href = 'login.html'; }, 7000);
        return;
      }
      showLoaderText('Welcome ‚Äî loading your course...');
      await onUserReady(user);
    });

    // logout
    els.logoutBtn.onclick = async ()=> {
      try{ await signOut(auth); location.href = 'login.html'; } catch(e){ location.href='login.html'; }
    };

    // theme toggle
    els.themeToggle.onclick = ()=>{
      document.body.classList.toggle('light');
      if(document.body.classList.contains('light')){
        document.documentElement.style.setProperty('--bg','#fff');
        document.documentElement.style.setProperty('--text','#111');
        document.documentElement.style.setProperty('--surface','#f0f0f0');
        document.documentElement.style.setProperty('--primary','#007bff');
      } else {
        document.documentElement.style.setProperty('--bg','#0a0e17');
        document.documentElement.style.setProperty('--text','#e0e0e0');
        document.documentElement.style.setProperty('--surface','#141a2a');
        document.documentElement.style.setProperty('--primary','#00ffe0');
      }
    };

    // small UX: hide loader after auth resolves or after a maximum wait
    (function waitForAuthResolve(){
      const maxWait = 10000;
      const start = Date.now();
      const check = setInterval(()=>{
        if(authResolved){ els.loader.style.display='none'; clearInterval(check); }
        if(Date.now() - start > maxWait){ els.loader.style.display='none'; clearInterval(check); }
      }, 300);
    })();

  </script>
</body>
</html>
