<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Web Application Penetration Testing – Cyber Buddy Academy</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    :root{--bg:#0a0e17;--surface:#141a2a;--primary:#00ffe0;--primary-dim: rgba(0, 255, 224, 0.1); --text:#e0e0e0;--muted:#9ca3af;--danger:#ff4d4d}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Poppins',system-ui;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;line-height:1.5}
    
    /* Modern Header */
    header{display:flex;align-items:center;justify-content:space-between;padding:15px 30px;background:rgba(10,14,23,.95);border-bottom:1px solid rgba(0,255,224,.1);position:sticky;top:0;z-index:100; backdrop-filter: blur(10px);}
    .logo{height:40px}
    .user-info{display:flex;align-items:center;gap:12px; border-left: 1px solid #333; padding-left: 15px;}
    .profile-pic{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid var(--primary)}
    nav{display:flex;gap:1.5rem;align-items:center}
    nav a,nav button{color:var(--text);background:none;border:none;cursor:pointer;text-decoration:none;font-size: 0.95rem; transition: 0.3s;}
    nav a:hover,nav button:hover{color:var(--primary);}

    /* Layout */
    .container{max-width:1100px;margin:2rem auto;padding:0 20px;opacity:0;transition:opacity .45s}
    .container.ready{opacity:1}
    
    h1{font-size:1.8rem;color:var(--primary);margin-bottom:1rem; border-left: 4px solid var(--primary); padding-left: 15px;}

    /* Video Section */
    .course-card{background:var(--surface);border-radius:16px;padding:25px;box-shadow:0 10px 40px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05);}
    
    .meta{display:flex;gap:1.5rem;align-items:center;margin-bottom:1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.05);}
    .meta img{width:120px;height:80px;object-fit:cover;border-radius:8px; box-shadow: 0 0 15px rgba(0,255,224,0.2);}
    
    .video-wrapper{position:relative;border-radius:12px;overflow:hidden;background:#000;margin-bottom:1.5rem;min-height:200px;display:flex;align-items:center;justify-content:center; border: 1px solid #333;}
    video{width:100%;display:block;max-height:70vh}
    
    .video-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.8);color:#fff;font-weight:600;opacity:0;transition:opacity .18s; z-index: 10;}
    .video-wrapper.error .video-overlay{opacity:1}

    /* Controls Bar */
    .controls{
        background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;
        display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin:1rem 0;
    }
    
    button.ctrl-btn, select, input[type=range] {
        background: #222; color: #fff; border: 1px solid #444; border-radius: 6px; padding: 8px 12px; cursor: pointer; transition: 0.3s; font-family: inherit; font-size: 0.9rem;
    }
    button.ctrl-btn:hover { border-color: var(--primary); color: var(--primary); }
    button#saveBookmark { background: var(--primary-dim); color: var(--primary); border-color: var(--primary); }
    button#saveBookmark:hover { background: var(--primary); color: #000; }
    
    .progress-bar{height:6px;background:#333;border-radius:6px;overflow:hidden;margin:1rem 0; position: relative;}
    .progress-fill{height:100%;background:var(--primary);width:0;transition:width .25s; box-shadow: 0 0 10px var(--primary);}
    
    /* Lists */
    details { margin-top: 1rem; background: rgba(255,255,255,0.02); padding: 10px; border-radius: 8px; }
    details summary{cursor:pointer;font-weight:600;color:var(--primary); padding: 5px;}
    .list{list-style:none;margin-top:.5rem;display:flex;flex-direction:column;gap:.4rem}
    .list li{display:flex;justify-content:space-between;align-items:center;padding:.8rem;background:rgba(0,0,0,0.3);border-radius:6px; border-left: 2px solid transparent; transition: 0.3s;}
    .list li:hover { border-left-color: var(--primary); background: rgba(255,255,255,0.03); }
    .list li button { background: none; border: 1px solid #555; color: #aaa; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
    .list li button:hover { border-color: var(--primary); color: var(--primary); }

    /* Loader */
    .loader{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:15px;background:var(--bg);z-index:9999}
    .spinner{width:50px;height:50px;border:4px solid #333;border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    footer{text-align:center;padding:20px;color:var(--muted);font-size:13px;margin-top:3rem; border-top: 1px solid rgba(255,255,255,0.05);}
    
    @media(max-width:768px){header{flex-direction:column;align-items:flex-start;gap:10px}.meta{flex-direction:column;align-items:flex-start}.meta img{width:100%;height:140px}}
    
    /* Modal */
    .modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.8);z-index:2000; backdrop-filter: blur(5px);}
    .modal{background:var(--surface);padding:25px;border-radius:12px;max-width:400px;width:90%;box-shadow:0 0 30px rgba(0,255,224,0.2);text-align:center; border: 1px solid var(--primary);}
    .modal button{margin:10px 5px; padding:8px 20px; background: var(--primary); border: none; font-weight: 600; cursor: pointer; border-radius: 4px;}
    .modal button#resumeNo { background: #333; color: white; }
  </style>
</head>
<body>
  <div class="loader" id="loader">
    <div class="spinner"></div>
    <div id="loaderText" style="color:var(--primary); letter-spacing: 1px;">INITIALIZING SYSTEM...</div>
  </div>

  <header id="header" style="display:none">
    <div style="display:flex;align-items:center;gap:10px">
      <img class="logo" src="https://raw.githubusercontent.com/Mubyyy404/photo-2/main/mylogo.png" alt="logo">
      <strong style="color:var(--primary); font-size: 1.1rem;">Cyber Buddy Academy</strong>
    </div>

    <div style="display:flex;align-items:center;gap:1rem">
      <nav>
        <a href="dashboard.html">Dashboard</a>
        <a href="course.html">My Courses</a>
        <a href="profile.html">Profile</a>
      </nav>

      <div class="user-info">
        <img id="profilePic" class="profile-pic" src="images/default-avatar.png" alt="profile">
        <div id="userName" style="color:#fff;font-weight:600; font-size: 0.9rem;">Loading...</div>
        <button id="logoutBtn" title="Logout"><i data-lucide="log-out" style="width:18px;"></i></button>
      </div>
       <button id="themeToggle" style="display:none;"></button>
    </div>
  </header>

  <main class="container" id="container">
    <h1 id="courseTitle">Web Application Penetration Testing</h1>

    <div id="accessDenied" style="display:none; padding:20px; background:rgba(255,77,77,0.1); border:1px solid var(--danger); color:var(--danger); text-align:center; border-radius:8px;">
      <strong>Access Denied:</strong> You have not purchased this course.<br><br>Redirecting...
    </div>

    <section id="courseContent" class="course-card" style="display:none">
      <div class="meta">
        <img id="courseImage" src="https://raw.githubusercontent.com/Mubyyy404/photo-2/refs/heads/main/Cloud%20Security.png" alt="course">
        <div>
          <h2 id="courseLabel" style="margin:0;color:var(--primary)">Web Application Pentesting</h2>
          <p id="courseDesc" style="margin:10px 0;color:var(--muted); line-height: 1.6;">Learn to identify, exploit, and secure web applications through hands-on labs.</p>
          <div id="videoStatus" class="notice" style="display:none"></div>
        </div>
      </div>

      <div class="video-wrapper" id="videoWrapper">
        <video id="courseVideo" preload="metadata" controls playsinline>
          </video>
        <div class="video-overlay" id="videoError">
          <div style="text-align:center;">
            <div id="videoErrorText" style="margin-bottom:10px;">Video Stream Interrupted</div>
            <button id="retryVideo" class="ctrl-btn">Retry Connection</button>
          </div>
        </div>
      </div>

      <div class="controls">
        <div style="display:flex; align-items:center; gap:10px;">
             <label for="playbackSpeed" style="font-size:0.85rem; color:#aaa;">Speed</label>
             <select id="playbackSpeed">
                 <option value="0.5">0.5x</option><option value="0.75">0.75x</option><option value="1" selected>1.0x</option><option value="1.25">1.25x</option><option value="1.5">1.5x</option><option value="2">2.0x</option>
             </select>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
             <label style="font-size:0.85rem; color:#aaa;">Vol</label>
             <input id="volumeControl" type="range" min="0" max="1" step="0.05" value="1">
        </div>
        <div>
            <button id="saveBookmark" class="ctrl-btn">Add Bookmark</button>
            <button id="fullscreenBtn" class="ctrl-btn">Full Screen</button>
            <button id="resetProgress" class="ctrl-btn" style="border-color:var(--danger); color:var(--danger);">Reset</button>
        </div>
      </div>

      <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
      <p id="progressText" style="text-align:right; font-size:0.8rem; color:var(--primary);">Watched: 0%</p>

      <details open>
          <summary>Saved Bookmarks (<span id="bmCount">0</span>)</summary>
          <ul id="bookmarksList" class="list"></ul>
      </details>
      
      <details>
          <summary>Course Chapters</summary>
          <ul id="chaptersList" class="list"></ul>
      </details>

    </section>
  </main>

  <footer id="footer" style="display:none">© 2025 Cyber Buddy Academy — All Rights Reserved</footer>

  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal" id="resumeModal">
      <h3 style="color:var(--primary); margin-top:0;">Welcome Back</h3>
      <div id="resumeText" style="margin: 15px 0;">Continue where you left off?</div>
      <div>
        <button id="resumeYes">Resume</button>
        <button id="resumeNo">Start Over</button>
      </div>
    </div>
  </div>

  <script type="module">
    // =========== VIDEO URL =============
    const VIDEO_URL = '/mnt/data/my website.txt'; // Replace with actual path
    // ===================================

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // --- CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyB2Zf5v8pK7z9xYcXvWqRtLkMhNjPxQmA0",
      authDomain: "cyber-buddy-academy.firebaseapp.com",
      projectId: "cyber-buddy-academy",
      storageBucket: "cyber-buddy-academy.appspot.com",
      messagingSenderId: "771234567890",
      appId: "1:771234567890:web:abcdef1234567890abcdef"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- ELEMENTS ---
    const els = {
      loader: document.getElementById('loader'),
      loaderText: document.getElementById('loaderText'),
      header: document.getElementById('header'),
      container: document.getElementById('container'),
      footer: document.getElementById('footer'),
      courseTitle: document.getElementById('courseTitle'),
      courseImage: document.getElementById('courseImage'),
      courseDesc: document.getElementById('courseDesc'),
      courseLabel: document.getElementById('courseLabel'),
      accessDenied: document.getElementById('accessDenied'),
      courseContent: document.getElementById('courseContent'),
      profilePic: document.getElementById('profilePic'),
      userName: document.getElementById('userName'),
      logoutBtn: document.getElementById('logoutBtn'),
      video: document.getElementById('courseVideo'),
      videoWrapper: document.getElementById('videoWrapper'),
      videoError: document.getElementById('videoError'),
      retryVideo: document.getElementById('retryVideo'),
      progressFill: document.getElementById('progressFill'),
      progressText: document.getElementById('progressText'),
      playbackSpeed: document.getElementById('playbackSpeed'),
      volumeControl: document.getElementById('volumeControl'),
      fullscreenBtn: document.getElementById('fullscreenBtn'),
      saveBookmark: document.getElementById('saveBookmark'),
      resetProgress: document.getElementById('resetProgress'),
      bookmarksList: document.getElementById('bookmarksList'),
      bmCount: document.getElementById('bmCount'),
      chaptersList: document.getElementById('chaptersList'),
      themeToggle: document.getElementById('themeToggle'),
      videoStatus: document.getElementById('videoStatus'),
      modalBackdrop: document.getElementById('modalBackdrop'),
      resumeText: document.getElementById('resumeText'),
      resumeYes: document.getElementById('resumeYes'),
      resumeNo: document.getElementById('resumeNo')
    };

    const COURSE_DOC_ID = 'web-pentesting';
    const COURSE_ID = 'web-pentesting';
    const PROGRESS_FIELD = 'webPentestingProgress';
    const BOOKMARK_FIELD = 'webPentestingBookmarks';
    const COMPLETED_FIELD = 'webPentestingCompleted';

    let userRef = null;
    let userData = null;
    let bookmarks = [];
    let saveTimer = null;
    let authResolved = false;
    let pendingResumePct = 0;

    const CHAPTERS = [
      { time: 0, label: '01. Introduction to Web Security' },
      { time: 300, label: '02. SQL Injection Fundamentals' },
      { time: 600, label: '03. Cross-Site Scripting (XSS)' },
      { time: 900, label: '04. Exploitation Techniques' }
    ];

    function showLoaderText(t){ els.loaderText.textContent = t.toUpperCase(); }
    function showUI(){ 
        els.loader.style.display='none'; 
        els.header.style.display='flex'; 
        els.container.classList.add('ready'); 
        els.footer.style.display='block';
    }
    function formatTime(sec){ const m=Math.floor(sec/60), s=Math.floor(sec%60); return `${m}:${s.toString().padStart(2,'0')}`; }

    function userHasCourse(userDoc, courseId){
      if(!userDoc) return false;
      const arrCandidates = [];
      if(Array.isArray(userDoc.purchasedCourses)) arrCandidates.push(userDoc.purchasedCourses);
      for(const arr of arrCandidates){
        for(const v of arr){
          if(typeof v === 'string' && v.toLowerCase() === courseId.toLowerCase()) return true;
        }
      }
      return false;
    }

    async function loadCourseMeta(){
      try{
        const cdoc = doc(db, 'courses', COURSE_DOC_ID);
        const snap = await getDoc(cdoc);
        if(snap.exists()){
          const d = snap.data();
          if(d.title) els.courseLabel.textContent = d.title;
          if(d.description) els.courseDesc.textContent = d.description;
          if(d.image) els.courseImage.src = d.image;
        }
      }catch(e){ console.warn('Meta load warning', e); }
    }

    async function saveProgress(pct){
      if(!userRef) return;
      try{ await updateDoc(userRef, { [PROGRESS_FIELD]: Math.max(0, Math.min(100, Math.floor(pct))) }); }
      catch(e){ console.warn('Progress save failed', e); }
    }
    
    async function saveBookmarks(arr){
      if(!userRef) return;
      try{ await updateDoc(userRef, { [BOOKMARK_FIELD]: arr }); }
      catch(e){ console.warn('Bookmark save failed', e); }
    }

    async function renderBookmarks(){
      try{
        if(userRef){
          const snap = await getDoc(userRef);
          if(snap.exists()){
            const db = snap.data();
            bookmarks = Array.isArray(db[BOOKMARK_FIELD]) ? db[BOOKMARK_FIELD].slice() : bookmarks;
          }
        }
      }catch(e){}
      
      els.bmCount.textContent = bookmarks.length;
      els.bookmarksList.innerHTML = '';
      if(!bookmarks.length){ els.bookmarksList.innerHTML = '<li style="justify-content:center; color:#666;">No bookmarks saved</li>'; return; }
      
      bookmarks.sort((a,b)=>a-b);
      bookmarks.forEach(sec=>{
        const li = document.createElement('li');
        li.innerHTML = `<span>⏱ ${formatTime(sec)}</span>`;
        const btn = document.createElement('button'); btn.textContent='JUMP TO';
        btn.onclick = ()=> { els.video.currentTime = sec; els.video.play(); };
        li.appendChild(btn);
        els.bookmarksList.appendChild(li);
      });
    }

    async function initPlayerState(){
      if(!userRef) return;
      const snap = await getDoc(userRef);
      const dbData = snap.exists() ? snap.data() : {};
      const pct = Number(dbData[PROGRESS_FIELD] ?? 0);
      bookmarks = Array.isArray(dbData[BOOKMARK_FIELD]) ? dbData[BOOKMARK_FIELD].slice() : [];
      pendingResumePct = pct;

      els.video.addEventListener('loadedmetadata', ()=> {
        if(pendingResumePct && pendingResumePct > 0 && pendingResumePct < 98){
          els.resumeText.textContent = `Continue from ${pendingResumePct.toFixed(0)}%?`;
          els.modalBackdrop.style.display = 'flex';
          
          els.resumeYes.onclick = ()=>{
            const t = (pendingResumePct/100)*els.video.duration;
            els.video.currentTime = Math.min(els.video.duration, t);
            els.video.play();
            els.modalBackdrop.style.display = 'none';
          };
          
          els.resumeNo.onclick = ()=>{
            els.video.currentTime = 0;
            els.modalBackdrop.style.display = 'none';
          };
        }
      });
      renderBookmarks();
    }

    function updateProgressUI(pct){
      const p = Math.max(0, Math.min(100, Number(pct) || 0));
      els.progressFill.style.width = p + '%';
      els.progressText.textContent = `Watched: ${p.toFixed(1)}%`;
    }

    function setupVideoControls(){
      const v = els.video;
      v.volume = els.volumeControl.value = 1;
      
      v.addEventListener('timeupdate', ()=>{
        const pct = (v.currentTime / Math.max(1, v.duration)) * 100 || 0;
        updateProgressUI(pct);
        if(saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(()=> saveProgress(Math.floor(pct)), 15000);
      });

      ['pause','ended'].forEach(ev=>{
        v.addEventListener(ev, async ()=>{
          const pct = Math.floor((v.currentTime / Math.max(1, v.duration)) * 100) || 0;
          await saveProgress(pct);
          if(ev === 'ended' && pct >= 95){
             try{ await updateDoc(userRef, { [COMPLETED_FIELD]: true }); }catch(e){}
             alert('Course Completed!');
          }
        });
      });

      v.addEventListener('error', ()=> { els.videoWrapper.classList.add('error'); });
      els.retryVideo.onclick = ()=> location.reload();
      els.playbackSpeed.onchange = ()=> v.playbackRate = parseFloat(els.playbackSpeed.value);
      els.volumeControl.oninput = ()=> v.volume = els.volumeControl.value;
      
      els.fullscreenBtn.onclick = ()=> { 
        if(v.requestFullscreen) v.requestFullscreen();
        else if(v.webkitRequestFullscreen) v.webkitRequestFullscreen();
      };

      els.saveBookmark.onclick = async ()=>{
        const t = Math.floor(v.currentTime || 0);
        if(bookmarks.includes(t)) return;
        bookmarks.push(t);
        await saveBookmarks(bookmarks);
        renderBookmarks();
      };

      els.resetProgress.onclick = async ()=>{
        if(!confirm('Reset all progress?')) return;
        v.currentTime = 0;
        bookmarks = [];
        try{ await updateDoc(userRef, { [PROGRESS_FIELD]: 0, [BOOKMARK_FIELD]: [], [COMPLETED_FIELD]: false }); }catch(e){}
        updateProgressUI(0);
        renderBookmarks();
      };
    }

    async function onUserReady(user){
      userRef = doc(db, 'users', user.uid);
      try{
        const snap = await getDoc(userRef);
        userData = snap.exists() ? snap.data() : {};
        loadCourseMeta();
        
        els.userName.textContent = user.displayName || userData.name || 'Student';
        els.profilePic.src = userData.profilePic || user.photoURL || 'images/default-avatar.png';

        if(!userHasCourse(userData, COURSE_ID)){
          showUI();
          els.accessDenied.style.display = 'block';
          els.courseContent.style.display = 'none';
          setTimeout(()=> location.href = 'dashboard.html', 3000);
          return;
        }

        els.accessDenied.style.display = 'none';
        els.courseContent.style.display = 'block';
        showUI();

        const sourceEl = document.createElement('source');
        sourceEl.src = VIDEO_URL;
        sourceEl.type = 'video/mp4';
        els.video.appendChild(sourceEl);

        setupVideoControls();
        await initPlayerState();
        renderChapters();
        if(window.lucide) lucide.createIcons();
      }catch(e){
        console.error(e);
      }
    }

    function renderChapters(){
      els.chaptersList.innerHTML = '';
      CHAPTERS.forEach(ch=>{
        const li = document.createElement('li');
        li.innerHTML = `<span>${ch.label}</span>`;
        const btn = document.createElement('button'); btn.textContent='Play';
        btn.onclick = ()=> { els.video.currentTime = ch.time; els.video.play(); };
        li.appendChild(btn);
        els.chaptersList.appendChild(li);
      });
    }

    onAuthStateChanged(auth, async (user) => {
      authResolved = true;
      if(!user){
        location.href = 'login.html';
        return;
      }
      await onUserReady(user);
    });

    els.logoutBtn.onclick = async ()=> {
      try{ await signOut(auth); location.href = 'login.html'; } catch(e){}
    };
    
  </script>
</body>
</html>
