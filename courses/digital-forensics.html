<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Forensics - Cyber Buddy Academy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        tailwind.config = {
            theme: { extend: { colors: { accent: '#00ffe0' } } }
        }
    </script>
    <style>
        body { font-family: 'Poppins', sans-serif; background: #0b1220; color: #e6f6f8; overflow-x: hidden; }
        .glow { text-shadow: 0 0 15px rgba(0, 255, 224, 0.4); color: #00ffe0; }
        .glass-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(0, 255, 224, 0.2); backdrop-filter: blur(10px); }
        .watermark { position: absolute; top: 15px; left: 15px; background: rgba(0, 0, 0, 0.6); color: #00ffe0; padding: 4px 10px; font-size: 11px; border-radius: 4px; pointer-events: none; z-index: 50; }
        .video-container { position: relative; width: 100%; aspect-ratio: 16 / 9; background: #000; border-radius: 16px; overflow: hidden; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-10">
    
    <header class="flex justify-between items-center max-w-6xl mx-auto mb-10">
        <div class="flex items-center gap-4">
            <img src="https://raw.githubusercontent.com/Mubyyy404/Cyber-Buddy/refs/heads/main/mylogo.png" alt="Logo" class="w-12 h-12">
            <h1 class="text-2xl font-bold glow">Digital Forensics</h1>
        </div>
        <button onclick="window.location.href='../dashboard.html'" class="bg-gray-700 hover:bg-gray-600 px-5 py-2 rounded-lg text-white">Back</button>
    </header>

    <main class="max-w-5xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 glass-card p-6 rounded-xl gap-4">
            <div class="text-left">
                <h2 id="moduleTitle" class="text-xl font-bold text-accent">Loading Module...</h2>
                <p id="moduleCount" class="text-sm text-gray-400">Step 1 of 4</p>
            </div>
            <div class="flex gap-2">
                <button onclick="changeModule(-1)" id="prevBtn" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded disabled:opacity-30">Previous</button>
                <button onclick="changeModule(1)" id="nextBtn" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded disabled:opacity-30">Next</button>
            </div>
        </div>

        
        <div class="video-container shadow-2xl border border-gray-800 mb-8">
            <div id="watermark" class="watermark">User: Loading...</div>
            <div id="player"></div>
        </div>

        <div class="glass-card p-6 rounded-xl">
            <div class="flex justify-between items-end mb-4">
                <div>
                    <h3 class="text-lg font-semibold">Course Progress</h3>
                    <p class="text-xs text-gray-400">Finish the video to automatically update progress.</p>
                </div>
                <span id="progressPercent" class="text-2xl font-bold text-accent">0%</span>
            </div>
            <div class="w-full bg-gray-800 h-4 rounded-full overflow-hidden">
                <div id="progressBar" class="bg-accent h-full transition-all duration-700 shadow-[0_0_15px_#00ffe0]" style="width: 0%"></div>
            </div>
        </div>
    </main>

    <script type="module">
        import { auth, db } from './js/firebase.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 1. CONFIGURATION: Add your YouTube Video IDs here
        const modules = [
            { id: "dxQvBzGAiDg", title: "Introduction to Digital Forensics" },
            { id: "eekzaI0UFDA", title: "Beginners DFIR Roadmap" },
            { id: "vD7uJ8aP0zA", title: "Forensics Full Course" },
            { id: "u2zgEFm5RHQ", title: "Advanced Extraction Techniques" }
        ];

        let player;
        let currentIndex = 0;
        let completedModules = new Array(modules.length).fill(false);
        let userUID = null;

        // 2. INITIALIZE YOUTUBE PLAYER
        window.onYouTubeIframeAPIReady = function() {
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                videoId: modules[0].id,
                playerVars: { 'rel': 0, 'modestbranding': 1 },
                events: {
                    'onStateChange': onPlayerStateChange
                }
            });
        };

        // 3. AUTH & LOAD SAVED PROGRESS
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userUID = user.uid;
                document.getElementById('watermark').innerText = `ID: ${user.email}`;
                
                // Fetch existing progress from Firestore
                const docRef = doc(db, "userProgress", userUID + "_forensics");
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    completedModules = docSnap.data().completedModules;
                    updateUI();
                }
                loadModule(0);
            } else {
                window.location.href = 'login.html';
            }
        });

        // 4. TRACK VIDEO COMPLETION
        function onPlayerStateChange(event) {
            // event.data === 0 means the video has ended
            if (event.data === YT.PlayerState.ENDED) {
                markCurrentModuleComplete();
            }
        }

        async function markCurrentModuleComplete() {
            if (!completedModules[currentIndex]) {
                completedModules[currentIndex] = true;
                updateUI();
                // Save to Firebase
                await setDoc(doc(db, "userProgress", userUID + "_forensics"), {
                    completedModules: completedModules,
                    courseName: "Digital Forensics",
                    lastUpdated: new Date()
                });
            }
        }

        // 5. NAVIGATION & UI
        window.loadModule = function(index) {
            currentIndex = index;
            const module = modules[index];
            
            if (player && player.loadVideoById) {
                player.loadVideoById(module.id);
            }

            document.getElementById('moduleTitle').innerText = module.title;
            document.getElementById('moduleCount').innerText = `Step ${index + 1} of ${modules.length}`;
            
            document.getElementById('prevBtn').disabled = (index === 0);
            document.getElementById('nextBtn').disabled = (index === modules.length - 1);
            updateUI();
        };

        function updateUI() {
            const finishedCount = completedModules.filter(x => x === true).length;
            const percentage = (finishedCount / modules.length) * 100;
            
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressPercent').innerText = Math.round(percentage) + '%';
        }

        window.changeModule = function(step) {
            let next = currentIndex + step;
            if (next >= 0 && next < modules.length) {
                loadModule(next);
            }
        };
    </script>
</body>
</html>
